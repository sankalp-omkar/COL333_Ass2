<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ River and Stones Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 15px;
        }

        .board-selection {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .board-btn {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .board-btn:hover {
            background: #007bff;
            color: white;
        }

        .board-btn.active {
            background: #007bff;
            color: white;
        }

        .game-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-waiting {
            background: #ffc107;
            color: #856404;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-finished {
            background: #dc3545;
            color: white;
        }

        .main-content {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        .game-board {
            flex: 1;
            background: #fff8e1;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #ddd;
        }

        .board-container {
            display: grid;
            gap: 2px;
            background: #333;
            padding: 10px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto;
        }

        .board-cell {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .scoring-cell {
            background: #e3f2fd !important;
            border: 2px solid #2196f3 !important;
        }

        .circle-piece {
            color: #f44336;
            font-weight: bold;
        }

        .square-piece {
            color: #2196f3;
            font-weight: bold;
        }

        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .player-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .player-circle {
            border-left-color: #f44336;
        }

        .player-square {
            border-left-color: #2196f3;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .player-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .connection-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
        }

        .current-turn {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .bot-instructions {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .bot-instructions h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .command {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 5px 0;
            border-left: 3px solid #007bff;
        }

        .game-log {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid #f39c12;
        }

        .winner-announcement h2 {
            color: #d68910;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .board-cell {
                width: 30px;
                height: 30px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ River and Stones</h1>
            <p>Web-based Multiplayer Game Server</p>
        </div>

        <div class="controls">
            <div class="board-selection">
                <span><strong>Board Size:</strong></span>
                <button class="board-btn active" onclick="selectBoardSize('small')" id="btn-small">
                    Small (13√ó12)
                </button>
                <button class="board-btn" onclick="selectBoardSize('medium')" id="btn-medium">
                    Medium (15√ó14)
                </button>
                <button class="board-btn" onclick="selectBoardSize('large')" id="btn-large">
                    Large (17√ó16)
                </button>
                <button class="board-btn" onclick="createNewGame()" style="background: #28a745; color: white; border-color: #28a745;">
                    Create New Game
                </button>
            </div>

            <div class="game-info">
                <div class="status-indicator status-waiting" id="game-status">
                    Waiting for Players
                </div>
                <div>Turn: <span id="turn-count">0</span></div>
            </div>
        </div>

        <div class="main-content">
            <div class="game-board">
                <h3 style="text-align: center; margin-bottom: 15px;">Game Board</h3>
                <div id="board-container" class="board-container">
                    <!-- Board will be generated here -->
                </div>
                <div id="winner-announcement" class="winner-announcement" style="display: none;">
                    <!-- Winner announcement will appear here -->
                </div>
            </div>

            <div class="sidebar">
                <div class="player-info player-circle" id="circle-info">
                    <div class="player-name">üî¥ Circle Player</div>
                    <div class="player-status">
                        <span>Status:</span>
                        <span class="connection-status disconnected" id="circle-status">Disconnected</span>
                    </div>
                    <div class="player-status">
                        <span>Time Left:</span>
                        <span class="time-display" id="circle-time">01:00</span>
                    </div>
                </div>

                <div class="player-info player-square" id="square-info">
                    <div class="player-name">üîµ Square Player</div>
                    <div class="player-status">
                        <span>Status:</span>
                        <span class="connection-status disconnected" id="square-status">Disconnected</span>
                    </div>
                    <div class="player-status">
                        <span>Time Left:</span>
                        <span class="time-display" id="square-time">01:00</span>
                    </div>
                </div>

                <div class="bot-instructions">
                    <h3>ü§ñ Bot Connection</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Connect bots from any system on the network
                    </p>
                    
                    <p><strong>üî¥ Circle Bot:</strong></p>
                    <div class="command" id="circle-command">python bot_client.py circle 8080</div>
                    
                    <p><strong>üîµ Square Bot:</strong></p>
                    <div class="command" id="square-command">python bot_client.py square 8080</div>
                </div>

                <div class="game-log">
                    <h3>Game Log</h3>
                    <div id="log-entries">
                        <div class="log-entry">Game initialized. Waiting for players...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let gameState = null;
        let selectedBoardSize = 'small';

        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                addLogEntry('Connected to game server');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                addLogEntry('Disconnected from server');
            });
            
            socket.on('game_update', function(data) {
                console.log('Game update received:', data);
                gameState = data;
                updateGameDisplay();
            });
            
            socket.on('game_created', function(data) {
                console.log('Game created:', data);
                addLogEntry(`New ${data.board_size} game created: ${data.game_id}`);
            });
        }

        // Board size selection
        function selectBoardSize(size) {
            selectedBoardSize = size;
            
            // Update button states
            document.querySelectorAll('.board-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${size}`).classList.add('active');
            
            addLogEntry(`Selected ${size} board size`);
        }

        // Create new game
        function createNewGame() {
            socket.emit('create_game', { board_size: selectedBoardSize });
            addLogEntry(`Creating new ${selectedBoardSize} game...`);
        }

        // Update game display
        function updateGameDisplay() {
            if (!gameState) return;
            
            // Update status
            const statusElement = document.getElementById('game-status');
            statusElement.textContent = gameState.game_status.charAt(0).toUpperCase() + gameState.game_status.slice(1);
            statusElement.className = `status-indicator status-${gameState.game_status}`;
            
            // Update turn count
            document.getElementById('turn-count').textContent = gameState.turn_count;
            
            // Update player info
            updatePlayerInfo('circle', gameState.players.circle);
            updatePlayerInfo('square', gameState.players.square);
            
            // Highlight current player
            const circleInfo = document.getElementById('circle-info');
            const squareInfo = document.getElementById('square-info');
            
            if (gameState.current_player === 'circle') {
                circleInfo.classList.add('current-turn');
                squareInfo.classList.remove('current-turn');
            } else {
                squareInfo.classList.add('current-turn');
                circleInfo.classList.remove('current-turn');
            }
            
            // Update board
            updateBoard();
            
            // Show winner if game finished
            if (gameState.winner) {
                showWinner();
            }
        }

        // Update player information
        function updatePlayerInfo(player, playerData) {
            const statusElement = document.getElementById(`${player}-status`);
            const timeElement = document.getElementById(`${player}-time`);
            
            // Update connection status
            if (playerData.connected) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'connection-status disconnected';
            }
            
            // Update time
            const minutes = Math.floor(playerData.time_left / 60);
            const seconds = Math.floor(playerData.time_left % 60);
            timeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update board display
        function updateBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            
            // Set grid template
            container.style.gridTemplateColumns = `repeat(${gameState.cols}, 1fr)`;
            
            // Create cells
            for (let row = 0; row < gameState.rows; row++) {
                for (let col = 0; col < gameState.cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    
                    // Check if this is a scoring cell
                    const isCircleScore = (row === 2) && gameState.score_cols.includes(col);
                    const isSquareScore = (row === gameState.rows - 3) && gameState.score_cols.includes(col);
                    
                    if (isCircleScore || isSquareScore) {
                        cell.classList.add('scoring-cell');
                    }
                    
                    // Add piece if present
                    const piece = gameState.board[row][col];
                    if (piece) {
                        if (piece.owner === 'circle') {
                            cell.classList.add('circle-piece');
                            if (piece.side === 'stone') {
                                cell.textContent = 'üî¥';
                            } else {
                                cell.textContent = piece.orientation === 'horizontal' ? 'üî¥‚Üî' : 'üî¥‚Üï';
                            }
                        } else {
                            cell.classList.add('square-piece');
                            if (piece.side === 'stone') {
                                cell.textContent = 'üîµ';
                            } else {
                                cell.textContent = piece.orientation === 'horizontal' ? 'üîµ‚Üî' : 'üîµ‚Üï';
                            }
                        }
                    } else if (isCircleScore) {
                        cell.textContent = 'üî¥';
                        cell.style.opacity = '0.3';
                    } else if (isSquareScore) {
                        cell.textContent = 'üîµ';
                        cell.style.opacity = '0.3';
                    }
                    
                    container.appendChild(cell);
                }
            }
        }

        // Show winner announcement
        function showWinner() {
            const announcement = document.getElementById('winner-announcement');
            const winner = gameState.winner;
            const scores = gameState.final_scores;
            
            if (!scores) return;
            
            const circleScore = scores.circle || 0;
            const squareScore = scores.square || 0;
            
            let content = '';
            
            if (winner === 'tie' || circleScore === squareScore) {
                // It's a tie
                content = `
                    <h2>ü§ù It's a Tie! ü§ù</h2>
                    <p style="font-size: 1.1em; margin: 10px 0;">Both players scored equally!</p>
                    <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px;">
                        <div>
                            <p style="font-size: 1.3em; font-weight: bold;">üî¥ Circle</p>
                            <p style="font-size: 1.8em; font-weight: bold;">${circleScore.toFixed(1)}</p>
                        </div>
                        <div style="font-size: 2em; align-self: center;">=</div>
                        <div>
                            <p style="font-size: 1.3em; font-weight: bold;">üîµ Square</p>
                            <p style="font-size: 1.8em; font-weight: bold;">${squareScore.toFixed(1)}</p>
                        </div>
                    </div>
                `;
                addLogEntry(`Game finished in a TIE! Both players scored ${circleScore.toFixed(1)} points`);
            } else {
                // There's a winner
                let winnerSymbol = winner === 'circle' ? 'üî¥' : 'üîµ';
                let winnerName = winner.charAt(0).toUpperCase() + winner.slice(1);
                let loserScore = winner === 'circle' ? squareScore : circleScore;
                let winnerScore = winner === 'circle' ? circleScore : squareScore;
                let scoreDiff = (winnerScore - loserScore).toFixed(1);
                
                content = `
                    <h2>üéâ ${winnerSymbol} ${winnerName} Wins! üéâ</h2>
                    <p style="font-size: 1.1em; margin: 10px 0;">Victory by ${scoreDiff} points!</p>
                    <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px;">
                        <div style="${winner === 'circle' ? 'transform: scale(1.1);' : ''}">
                            <p style="font-size: 1.3em; font-weight: bold;">üî¥ Circle</p>
                            <p style="font-size: 1.8em; font-weight: bold; ${winner === 'circle' ? 'color: #d68910;' : ''}">${circleScore.toFixed(1)}</p>
                            ${winner === 'circle' ? '<p style="font-size: 0.9em;">üëë Winner</p>' : ''}
                        </div>
                        <div style="font-size: 2em; align-self: center;">vs</div>
                        <div style="${winner === 'square' ? 'transform: scale(1.1);' : ''}">
                            <p style="font-size: 1.3em; font-weight: bold;">üîµ Square</p>
                            <p style="font-size: 1.8em; font-weight: bold; ${winner === 'square' ? 'color: #d68910;' : ''}">${squareScore.toFixed(1)}</p>
                            ${winner === 'square' ? '<p style="font-size: 0.9em;">üëë Winner</p>' : ''}
                        </div>
                    </div>
                `;
                addLogEntry(`Game finished! ${winnerName} wins with ${winnerScore.toFixed(1)} points (vs ${loserScore.toFixed(1)})`);
            }
            
            announcement.innerHTML = content;
            announcement.style.display = 'block';
        }

        // Add entry to game log
        function addLogEntry(message) {
            const logEntries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            initSocket();
            
            // Display server IP for remote connections
            const hostname = window.location.hostname;
            if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                const remoteInfo = document.createElement('p');
                remoteInfo.style.cssText = 'margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 0.85em;';
                remoteInfo.innerHTML = `<strong>Server IP:</strong> ${hostname}`;
                document.querySelector('.bot-instructions').appendChild(remoteInfo);
            }
            
            // Load initial game state
            fetch('/api/game_state')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // No game exists, that's ok
                        addLogEntry('No active game. Create a new game to start.');
                    } else {
                        gameState = data;
                        updateGameDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading game state:', error);
                });
        });
    </script>
</body>
</html>